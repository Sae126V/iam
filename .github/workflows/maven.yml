name: build & packaging

on: [push, pull_request] 

jobs:
  build:
    strategy:
      matrix:
        java-version: [17]

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set up JDK ${{matrix.java-version}}
      uses: actions/setup-java@v2
      with:
        distribution: temurin
        cache: maven
        java-version: ${{matrix.java-version}}

    - name: License check
      run: mvn -B license:check

    - name: Build, test, package
      run: mvn -U -B clean package

    - name: Copy artifacts to docker dir
      run: mvn -DskipTests=true -U -B spring-boot:build-image

    - name: Build docker images (packeto)
      run: mvn -DskipTests=true -U -B spring-boot:build-image

    - name: Docker login
      if: startsWith(github.ref, 'refs/tags/')
      uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Publish docker-image
      if: startsWith(github.ref, 'refs/tags/')
      run: bash utils/tag-push-images.sh  ${GITHUB_REF#refs/tags/}
